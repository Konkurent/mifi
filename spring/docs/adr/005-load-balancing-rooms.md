# ADR-005: Равномерное распределение нагрузки по номерам

**Статус:** Принято  
**Дата:** 2025

## Контекст

При автоматическом выборе номера для бронирования необходимо распределять нагрузку равномерно между всеми доступными номерами, чтобы:
- Избежать ситуации, когда одни номера перегружены, а другие простаивают
- Обеспечить справедливое использование ресурсов
- Оптимизировать загрузку отеля

## Решение

Реализована сортировка доступных номеров по количеству бронирований (`timesBooked ASC`) при выборе.

### Алгоритм:
```java
// В RoomRepository
@Query("SELECT r FROM Room r WHERE r.available = true ORDER BY r.timesBooked ASC")
List<Room> findAvailableRoomsOrderedByTimesBooked();

// В RoomService.resolveAvailableRoomId()
List<Room> availableRooms = roomRepository.findAvailableRoomsOrderedByTimesBooked();
Room selectedRoom = availableRooms.stream()
    .filter(room -> !excludeRooms.contains(room.getId()))
    .findFirst()  // Выбирается первый (с наименьшим timesBooked)
    .orElseThrow(...);
```

### Логика:
1. Получаем все доступные номера, отсортированные по `timesBooked ASC`
2. Исключаем номера, уже забронированные на нужные даты
3. Выбираем первый доступный номер (с наименьшим `timesBooked`)
4. Это обеспечивает равномерное распределение

## Обоснование

### Преимущества:
- ✅ **Равномерное распределение**: Номера используются пропорционально
- ✅ **Простота реализации**: Стандартный SQL запрос с сортировкой
- ✅ **Эффективность**: Минимальные накладные расходы
- ✅ **Справедливость**: Все номера получают примерно равную нагрузку

### Недостатки:
- ⚠️ **Требует индекс**: Для производительности нужен индекс на `times_booked`
- ⚠️ **Сортировка при каждом запросе**: При большом количестве номеров может быть медленнее

## Альтернативы

### Round-Robin (циклический выбор)
**Отклонено**, так как:
- Не учитывает текущую загрузку номеров
- Требует хранения состояния (какой номер следующий)
- Не работает при масштабировании

### Случайный выбор
**Отклонено**, так как:
- Не гарантирует равномерное распределение
- Возможны "горячие точки" случайно

### Weighted Round-Robin
**Рассмотрено**, но текущее решение проще и достаточное

## Индексы БД

**Рекомендуется** добавить индекс для оптимизации:
```sql
CREATE INDEX idx_rooms_times_booked ON rooms(times_booked) WHERE available = true;
```

Это ускорит сортировку при большом количестве номеров.

## Мониторинг

Важно отслеживать:
- Среднее значение `timesBooked` по всем номерам
- Дисперсию значений `timesBooked` (показывает равномерность)
- Номера с экстремально высоким/низким `timesBooked`

## Последствия

### Производительность:
- ✅ Быстрый выбор при наличии индекса
- ⚠️ При большом количестве номеров (>1000) может потребоваться оптимизация

### Бизнес-логика:
- ✅ Оптимальное использование номеров
- ✅ Справедливое распределение нагрузки
- ✅ Простота понимания логики

## Резюме

Сортировка по `timesBooked ASC` обеспечивает простое и эффективное решение для равномерного распределения нагрузки между номерами. Это гарантирует оптимальное использование ресурсов без сложной логики или внешних компонентов.

